import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class CalendarService {
    constructor() {
        this._currentDate = new Date();
        this.currentDateChangedFromParent = new Subject();
        this.currentDateChangedFromChildren = new Subject();
        this.eventSourceChanged = new Subject();
        this.slideChanged = new Subject();
        this.slideUpdated = new Subject();
        this.currentDateChangedFromParent$ = this.currentDateChangedFromParent.asObservable();
        this.currentDateChangedFromChildren$ = this.currentDateChangedFromChildren.asObservable();
        this.eventSourceChanged$ = this.eventSourceChanged.asObservable();
        this.slideChanged$ = this.slideChanged.asObservable();
        this.slideUpdated$ = this.slideUpdated.asObservable();
    }
    setCurrentDate(val, fromParent = false) {
        this._currentDate = new Date(val);
        if (fromParent) {
            this.currentDateChangedFromParent.next(val);
        }
        else {
            this.currentDateChangedFromChildren.next(val);
        }
    }
    get currentDate() {
        return this._currentDate;
    }
    rangeChanged(component) {
        if (this.queryMode === 'local') {
            if (component.eventSource && component.onDataLoaded) {
                component.onDataLoaded();
            }
        }
        else if (this.queryMode === 'remote') {
            let rangeStart = new Date(component.range.startTime.getTime()), rangeEnd = new Date(component.range.endTime.getTime());
            rangeStart.setHours(0);
            if (rangeStart.getHours() === 23) {
                rangeStart.setTime(rangeStart.getTime() + 3600000);
            }
            rangeEnd.setHours(0);
            if (rangeEnd.getHours() === 23) {
                rangeEnd.setTime(rangeEnd.getTime() + 3600000);
            }
            component.onRangeChanged.emit({
                startTime: rangeStart,
                endTime: rangeEnd
            });
        }
    }
    getStep(mode) {
        switch (mode) {
            case 'month':
                return {
                    years: 0,
                    months: 1,
                    days: 0
                };
            case 'week':
                return {
                    years: 0,
                    months: 0,
                    days: 7
                };
            case 'day':
                return {
                    years: 0,
                    months: 0,
                    days: 1
                };
        }
    }
    getAdjacentCalendarDate(mode, direction) {
        let calculateCalendarDate = this.currentDate;
        const step = this.getStep(mode), year = calculateCalendarDate.getFullYear() + direction * step.years, month = calculateCalendarDate.getMonth() + direction * step.months, date = calculateCalendarDate.getDate() + direction * step.days;
        calculateCalendarDate = new Date(year, month, date, 12, 0, 0);
        if (mode === 'month') {
            const firstDayInNextMonth = new Date(year, month + 1, 1, 12, 0, 0);
            if (firstDayInNextMonth.getTime() <= calculateCalendarDate.getTime()) {
                calculateCalendarDate = new Date(firstDayInNextMonth.getTime() - 24 * 60 * 60 * 1000);
            }
        }
        return calculateCalendarDate;
    }
    getAdjacentViewStartTime(component, direction) {
        let adjacentCalendarDate = this.getAdjacentCalendarDate(component.mode, direction);
        return component.getRange(adjacentCalendarDate).startTime;
    }
    populateAdjacentViews(component) {
        let currentViewStartDate, currentViewData, toUpdateViewIndex, currentViewIndex = component.currentViewIndex;
        if (component.direction === 1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
            toUpdateViewIndex = (currentViewIndex + 1) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else if (component.direction === -1) {
            currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
            toUpdateViewIndex = (currentViewIndex + 2) % 3;
            component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
        }
        else {
            if (!component.views) {
                currentViewData = [];
                currentViewStartDate = component.range.startTime;
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                currentViewData.push(component.getViewData(currentViewStartDate));
                component.views = currentViewData;
            }
            else {
                currentViewStartDate = component.range.startTime;
                component.views[currentViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, -1);
                toUpdateViewIndex = (currentViewIndex + 2) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
                currentViewStartDate = this.getAdjacentViewStartTime(component, 1);
                toUpdateViewIndex = (currentViewIndex + 1) % 3;
                component.views[toUpdateViewIndex] = component.getViewData(currentViewStartDate);
            }
        }
    }
    loadEvents() {
        this.eventSourceChanged.next();
    }
    slide(direction) {
        this.slideChanged.next(direction);
    }
    update() {
        this.slideUpdated.next();
    }
}
CalendarService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.1.2", ngImport: i0, type: CalendarService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
CalendarService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.1.2", ngImport: i0, type: CalendarService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.1.2", ngImport: i0, type: CalendarService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jYWxlbmRhci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFhLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQzs7QUFLekMsTUFBTSxPQUFPLGVBQWU7SUFleEI7UUFQUSxpQkFBWSxHQUFTLElBQUksSUFBSSxFQUFFLENBQUM7UUFDaEMsaUNBQTRCLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUNuRCxtQ0FBOEIsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ3JELHVCQUFrQixHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDekMsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3JDLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUd2QyxJQUFJLENBQUMsNkJBQTZCLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RGLElBQUksQ0FBQywrQkFBK0IsR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDMUYsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEQsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzFELENBQUM7SUFFRCxjQUFjLENBQUMsR0FBUyxFQUFFLGFBQXNCLEtBQUs7UUFDakQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQyxJQUFJLFVBQVUsRUFBRTtZ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Q0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEUsaUJBQWlCLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQy9DLFNBQVMsQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLG9CQUFvQixDQUFDLENBQUM7Z0JBQ2pGLG9CQUFvQixHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ25FLGlCQUFpQixHQUFHLENBQUMsZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMvQyxTQUFTLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2FBQ3BGO1NBQ0o7SUFDTCxDQUFDO0lBRUQsVUFBVTtRQUNOLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQWlCO1FBQ25CLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxNQUFNO1FBQ0YsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUM3QixDQUFDOzs0R0ExSlEsZUFBZTtnSEFBZixlQUFlOzJGQUFmLGVBQWU7a0JBRDNCLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJqZWN0fSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtJQ2FsZW5kYXJDb21wb25lbnQsIElWaWV3LCBDYWxlbmRhck1vZGUsIFF1ZXJ5TW9kZX0gZnJvbSAnLi9jYWxlbmRhci5pbnRlcmZhY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ2FsZW5kYXJTZXJ2aWNlIHtcbiAgICBxdWVyeU1vZGUhOiBRdWVyeU1vZGU7XG4gICAgY3VycmVudERhdGVDaGFuZ2VkRnJvbVBhcmVudCQ6IE9ic2VydmFibGU8RGF0ZT47XG4gICAgY3VycmVudERhdGVDaGFuZ2VkRnJvbUNoaWxkcmVuJDogT2JzZXJ2YWJsZTxEYXRlPjtcbiAgICBldmVudFNvdXJjZUNoYW5nZWQkOiBPYnNlcnZhYmxlPHZvaWQ+O1xuICAgIHNsaWRlQ2hhbmdlZCQ6IE9ic2VydmFibGU8bnVtYmVyPjtcbiAgICBzbGlkZVVwZGF0ZWQkOiBPYnNlcnZhYmxlPHZvaWQ+O1xuXG4gICAgcHJpdmF0ZSBfY3VycmVudERhdGU6IERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIHByaXZhdGUgY3VycmVudERhdGVDaGFuZ2VkRnJvbVBhcmVudCA9IG5ldyBTdWJqZWN0PERhdGU+KCk7XG4gICAgcHJpdmF0ZSBjdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4gPSBuZXcgU3ViamVjdDxEYXRlPigpO1xuICAgIHByaXZhdGUgZXZlbnRTb3VyY2VDaGFuZ2VkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgICBwcml2YXRlIHNsaWRlQ2hhbmdlZCA9IG5ldyBTdWJqZWN0PG51bWJlcj4oKTtcbiAgICBwcml2YXRlIHNsaWRlVXBkYXRlZCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50JCA9IHRoaXMuY3VycmVudERhdGVDaGFuZ2VkRnJvbVBhcmVudC5hc09ic2VydmFibGUoKTtcbiAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4kID0gdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tQ2hpbGRyZW4uYXNPYnNlcnZhYmxlKCk7XG4gICAgICAgIHRoaXMuZXZlbnRTb3VyY2VDaGFuZ2VkJCA9IHRoaXMuZXZlbnRTb3VyY2VDaGFuZ2VkLmFzT2JzZXJ2YWJsZSgpO1xuICAgICAgICB0aGlzLnNsaWRlQ2hhbmdlZCQgPSB0aGlzLnNsaWRlQ2hhbmdlZC5hc09ic2VydmFibGUoKTtcbiAgICAgICAgdGhpcy5zbGlkZVVwZGF0ZWQkID0gdGhpcy5zbGlkZVVwZGF0ZWQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgc2V0Q3VycmVudERhdGUodmFsOiBEYXRlLCBmcm9tUGFyZW50OiBib29sZWFuID0gZmFsc2UpIHtcbiAgICAgICAgdGhpcy5fY3VycmVudERhdGUgPSBuZXcgRGF0ZSh2YWwpO1xuICAgICAgICBpZiAoZnJvbVBhcmVudCkge1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50RGF0ZUNoYW5nZWRGcm9tUGFyZW50Lm5leHQodmFsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudERhdGVDaGFuZ2VkRnJvbUNoaWxkcmVuLm5leHQodmFsKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldCBjdXJyZW50RGF0ZSgpOiBEYXRlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnREYXRlO1xuICAgIH1cblxuICAgIHJhbmdlQ2hhbmdlZChjb21wb25lbnQ6IElDYWxlbmRhckNvbXBvbmVudCkge1xuICAgICAgICBpZiAodGhpcy5xdWVyeU1vZGUgPT09ICdsb2NhbCcpIHtcbiAgICAgICAgICAgIGlmIChjb21wb25lbnQuZXZlbnRTb3VyY2UgJiYgY29tcG9uZW50Lm9uRGF0YUxvYWRlZCkge1xuICAgICAgICAgICAgICAgIGNvbXBvbmVudC5vbkRhdGFMb2FkZWQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnF1ZXJ5TW9kZSA9PT0gJ3JlbW90ZScpIHtcbiAgICAgICAgICAgIGxldCByYW5nZVN0YXJ0ID0gbmV3IERhdGUoY29tcG9uZW50LnJhbmdlLnN0YXJ0VGltZS5nZXRUaW1lKCkpLFxuICAgICAgICAgICAgICAgIHJhbmdlRW5kID0gbmV3IERhdGUoY29tcG9uZW50LnJhbmdlLmVuZFRpbWUuZ2V0VGltZSgpKTtcblxuICAgICAgICAgICAgcmFuZ2VTdGFydC5zZXRIb3VycygwKTtcbiAgICAgICAgICAgIGlmIChyYW5nZVN0YXJ0LmdldEhvdXJzKCkgPT09IDIzKSB7XG4gICAgICAgICAgICAgICAgcmFuZ2VTdGFydC5zZXRUaW1lKHJhbmdlU3RhcnQuZ2V0VGltZSgpICsgMzYwMDAwMCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJhbmdlRW5kLnNldEhvdXJzKDApO1xuICAgICAgICAgICAgaWYgKHJhbmdlRW5kLmdldEhvdXJzKCkgPT09IDIzKSB7XG4gICAgICAgICAgICAgICAgcmFuZ2VFbmQuc2V0VGltZShyYW5nZUVuZC5nZXRUaW1lKCkgKyAzNjAwMDAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbXBvbmVudC5vblJhbmdlQ2hhbmdlZC5lbWl0KHtcbiAgICAgICAgICAgICAgICBzdGFydFRpbWU6IHJhbmdlU3RhcnQsXG4gICAgICAgICAgICAgICAgZW5kVGltZTogcmFuZ2VFbmRcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRTdGVwKG1vZGU6IENhbGVuZGFyTW9kZSk6IHsgeWVhcnM6IG51bWJlcjsgbW9udGhzOiBudW1iZXI7IGRheXM6IG51bWJlcjsgfSB7XG4gICAgICAgIHN3aXRjaCAobW9kZSkge1xuICAgICAgICAgICAgY2FzZSAnbW9udGgnOlxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHllYXJzOiAwLFxuICAgICAgICAgICAgICAgICAgICBtb250aHM6IDEsXG4gICAgICAgICAgICAgICAgICAgIGRheXM6IDBcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgY2FzZSAnd2Vlayc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgeWVhcnM6IDAsXG4gICAgICAgICAgICAgICAgICAgIG1vbnRoczogMCxcbiAgICAgICAgICAgICAgICAgICAgZGF5czogN1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjYXNlICdkYXknOlxuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIHllYXJzOiAwLFxuICAgICAgICAgICAgICAgICAgICBtb250aHM6IDAsXG4gICAgICAgICAgICAgICAgICAgIGRheXM6IDFcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0QWRqYWNlbnRDYWxlbmRhckRhdGUobW9kZTogQ2FsZW5kYXJNb2RlLCBkaXJlY3Rpb246IG51bWJlcik6IERhdGUge1xuICAgICAgICBsZXQgY2FsY3VsYXRlQ2FsZW5kYXJEYXRlID0gdGhpcy5jdXJyZW50RGF0ZTtcbiAgICAgICAgY29uc3Qgc3RlcCA9IHRoaXMuZ2V0U3RlcChtb2RlKSxcbiAgICAgICAgICAgIHllYXIgPSBjYWxjdWxhdGVDYWxlbmRhckRhdGUuZ2V0RnVsbFllYXIoKSArIGRpcmVjdGlvbiAqIHN0ZXAueWVhcnMsXG4gICAgICAgICAgICBtb250aCA9IGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZS5nZXRNb250aCgpICsgZGlyZWN0aW9uICogc3RlcC5tb250aHMsXG4gICAgICAgICAgICBkYXRlID0gY2FsY3VsYXRlQ2FsZW5kYXJEYXRlLmdldERhdGUoKSArIGRpcmVjdGlvbiAqIHN0ZXAuZGF5cztcblxuICAgICAgICBjYWxjdWxhdGVDYWxlbmRhckRhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF0ZSwgMTIsIDAsIDApO1xuXG4gICAgICAgIGlmIChtb2RlID09PSAnbW9udGgnKSB7XG4gICAgICAgICAgICBjb25zdCBmaXJzdERheUluTmV4dE1vbnRoID0gbmV3IERhdGUoeWVhciwgbW9udGggKyAxLCAxLCAxMiwgMCwgMCk7XG4gICAgICAgICAgICBpZiAoZmlyc3REYXlJbk5leHRNb250aC5nZXRUaW1lKCkgPD0gY2FsY3VsYXRlQ2FsZW5kYXJEYXRlLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgIGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZSA9IG5ldyBEYXRlKGZpcnN0RGF5SW5OZXh0TW9udGguZ2V0VGltZSgpIC0gMjQgKiA2MCAqIDYwICogMTAwMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNhbGN1bGF0ZUNhbGVuZGFyRGF0ZTtcbiAgICB9XG5cbiAgICBnZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50OiBJQ2FsZW5kYXJDb21wb25lbnQsIGRpcmVjdGlvbjogbnVtYmVyKTogRGF0ZSB7XG4gICAgICAgIGxldCBhZGphY2VudENhbGVuZGFyRGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRDYWxlbmRhckRhdGUoY29tcG9uZW50Lm1vZGUsIGRpcmVjdGlvbik7XG4gICAgICAgIHJldHVybiBjb21wb25lbnQuZ2V0UmFuZ2UoYWRqYWNlbnRDYWxlbmRhckRhdGUpLnN0YXJ0VGltZTtcbiAgICB9XG5cbiAgICBwb3B1bGF0ZUFkamFjZW50Vmlld3MoY29tcG9uZW50OiBJQ2FsZW5kYXJDb21wb25lbnQpIHtcbiAgICAgICAgbGV0IGN1cnJlbnRWaWV3U3RhcnREYXRlOiBEYXRlLFxuICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhOiBJVmlld1tdLFxuICAgICAgICAgICAgdG9VcGRhdGVWaWV3SW5kZXg6IG51bWJlcixcbiAgICAgICAgICAgIGN1cnJlbnRWaWV3SW5kZXggPSBjb21wb25lbnQuY3VycmVudFZpZXdJbmRleDtcblxuICAgICAgICBpZiAoY29tcG9uZW50LmRpcmVjdGlvbiA9PT0gMSkge1xuICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIDEpO1xuICAgICAgICAgICAgdG9VcGRhdGVWaWV3SW5kZXggPSAoY3VycmVudFZpZXdJbmRleCArIDEpICUgMztcbiAgICAgICAgICAgIGNvbXBvbmVudC52aWV3c1t0b1VwZGF0ZVZpZXdJbmRleF0gPSBjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpO1xuICAgICAgICB9IGVsc2UgaWYgKGNvbXBvbmVudC5kaXJlY3Rpb24gPT09IC0xKSB7XG4gICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgLTEpO1xuICAgICAgICAgICAgdG9VcGRhdGVWaWV3SW5kZXggPSAoY3VycmVudFZpZXdJbmRleCArIDIpICUgMztcbiAgICAgICAgICAgIGNvbXBvbmVudC52aWV3c1t0b1VwZGF0ZVZpZXdJbmRleF0gPSBjb21wb25lbnQuZ2V0Vmlld0RhdGEoY3VycmVudFZpZXdTdGFydERhdGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCFjb21wb25lbnQudmlld3MpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld0RhdGEgPSBbXTtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IGNvbXBvbmVudC5yYW5nZS5zdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhLnB1c2goY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKSk7XG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIDEpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3RGF0YS5wdXNoKGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSkpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3U3RhcnREYXRlID0gdGhpcy5nZXRBZGphY2VudFZpZXdTdGFydFRpbWUoY29tcG9uZW50LCAtMSk7XG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdEYXRhLnB1c2goY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKSk7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzID0gY3VycmVudFZpZXdEYXRhO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IGNvbXBvbmVudC5yYW5nZS5zdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW2N1cnJlbnRWaWV3SW5kZXhdID0gY29tcG9uZW50LmdldFZpZXdEYXRhKGN1cnJlbnRWaWV3U3RhcnREYXRlKTtcbiAgICAgICAgICAgICAgICBjdXJyZW50Vmlld1N0YXJ0RGF0ZSA9IHRoaXMuZ2V0QWRqYWNlbnRWaWV3U3RhcnRUaW1lKGNvbXBvbmVudCwgLTEpO1xuICAgICAgICAgICAgICAgIHRvVXBkYXRlVmlld0luZGV4ID0gKGN1cnJlbnRWaWV3SW5kZXggKyAyKSAlIDM7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW3RvVXBkYXRlVmlld0luZGV4XSA9IGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSk7XG4gICAgICAgICAgICAgICAgY3VycmVudFZpZXdTdGFydERhdGUgPSB0aGlzLmdldEFkamFjZW50Vmlld1N0YXJ0VGltZShjb21wb25lbnQsIDEpO1xuICAgICAgICAgICAgICAgIHRvVXBkYXRlVmlld0luZGV4ID0gKGN1cnJlbnRWaWV3SW5kZXggKyAxKSAlIDM7XG4gICAgICAgICAgICAgICAgY29tcG9uZW50LnZpZXdzW3RvVXBkYXRlVmlld0luZGV4XSA9IGNvbXBvbmVudC5nZXRWaWV3RGF0YShjdXJyZW50Vmlld1N0YXJ0RGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBsb2FkRXZlbnRzKCkge1xuICAgICAgICB0aGlzLmV2ZW50U291cmNlQ2hhbmdlZC5uZXh0KCk7XG4gICAgfVxuXG4gICAgc2xpZGUoZGlyZWN0aW9uOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5zbGlkZUNoYW5nZWQubmV4dChkaXJlY3Rpb24pO1xuICAgIH1cblxuICAgIHVwZGF0ZSgpIHtcbiAgICAgICAgdGhpcy5zbGlkZVVwZGF0ZWQubmV4dCgpO1xuICAgIH1cbn1cbiJdfQ==